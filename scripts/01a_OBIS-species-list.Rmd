---
title: "01a_OBIS-species-list"
author: "Kate Sheridan"
date: "3/29/2023"
output: html_document
---

This script pulls species data from OBIS to generate a species list for a defined region.
May be able to update with a shapefile?

Currently it pulls and cleans a checklist() but can be updated later for occurrence()

OBIS already uses the WoRMS taxonomic backbone so no adjustment to taxonomy was necessary.
Note that currently Species and Subspecies is preserved; in some cases the species column for a subspecies is unique. This seems to be a largely invertebrate-specific situation. 
So when using these lists for analysis: `select(species) %>% distinct()` instead of `filter(taxon_rank == 'species')`

```{r setup, include=FALSE}
library(robis)
#library(obistools) # for cleaning occurrence data
library(tidyverse)
library(here)
```

```{r scrape-data}
# Bounding box for region; formatted as a well-known text object
## (lat long, lat long, lat long, lat long) where each pair is a corner of the bounding box, then closed
obis_bb <- "POLYGON((-161.261728 34.532973,-116.613291 34.532973, -116.613291 62.729976, -161.261728 62.729976, -161.261728 34.532973))"


# occurrence data: all records
#obisdat <- occurrence(geometry = obis_bb)

# checklist for species/taxonomy lst
obisdat <- checklist(geometry = obis_bb)

# if the download is large:
#save so we don't have to download again
#save(obisdat, file = here('rawdata', 'species_lists', '20230329_obis-checklist.RData'))
# load if needed
#load(here('rawdata', 'species_lists', '20230329_obis-checklist.RData'))
```



# Fish

```{r fish filter taxonomy}
obisfish <- obisdat %>%
  # only species level records
  filter(taxonRank %in% c('Species', 'Subspecies')) %>%
  # only fish; polyphyletic so can be complicated
  # class covers most of it, some sculpins lack class though
  filter(class %in% c('Actinopteri', 'Elasmobranchii', 'Holocephali',
                      'Petromyzonti', 'Myxini') |
           order %in% c('Scorpaeniformes')) %>%
  # only records that have accepted taxonomy for now
  filter(taxonomicStatus == 'accepted') %>%
  #select only useful columns for now
  select(species, subspecies, taxonRank,
         class, order, family, genus, 
         is_marine, is_brackish, is_freshwater,
         speciesid, taxonID, bold_id, ncbi_id) %>%
  # just in case
  distinct() %>%
  # rank to lowercase to match other databases
  mutate(taxonRank = tolower(taxonRank)) %>%
  # standardize column names
  janitor::clean_names()
  


write_csv(obisfish, here('processeddata', 'species_lists', 'region', '20230329_obis-fish.csv'))
```


# Invertebrates

```{r invertebrates filter taxonomy}
obisinverts <- obisdat %>%
  # only species-level records
  filter(taxonRank %in% c('Species', 'Subspecies')) %>%
  # only animals
  filter(kingdom == 'Animalia') %>%
  # only not-vertebrates, 
  # but includes non-vertebrate chordates
  ## c() will also include any NAs in subphylum
  filter(!(subphylum %in% c('Vertebrata'))) %>%
  # only records that have accepted taxonomy for now
  filter(taxonomicStatus == 'accepted') %>%
  #select only useful columns for now
  select(species, subspecies, taxonRank,
         phylum, class, order, family, genus, 
         is_marine, is_brackish, is_freshwater,
         speciesid, taxonID, bold_id, ncbi_id) %>%
  # just in case
  distinct() %>%
  # rank to lowercase to match other databases
  mutate(taxonRank = tolower(taxonRank)) %>%
  # standardize column names
  janitor::clean_names()


write_csv(obisinverts, here('processeddata', 'species_lists', 'region', '20230329_obis-invertebrates.csv'))

```


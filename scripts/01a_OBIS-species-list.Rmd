---
title: "01a_OBIS-species-list"
author: "Kate Sheridan"
date: "3/29/2023"
output: html_document
---

This script pulls species data from OBIS to generate a species list for a defined region.
May be able to update with a shapefile?

Currently it pulls and cleans a checklist() but can be updated later for occurrence()

OBIS already uses the WoRMS taxonomic backbone so no adjustment to taxonomy was necessary.
Note that currently Species and Subspecies is preserved; in some cases the species column for a subspecies is unique. This seems to be a largely invertebrate-specific situation. 
So when using these lists for analysis: `select(species) %>% distinct()` instead of `filter(taxon_rank == 'species')`

```{r setup, include=FALSE}
library(robis)
#library(obistools) # for cleaning occurrence data
library(tidyverse)
library(here)

# here filepaths
splists <- here('processeddata', 'species_lists', 'region')
spatial <- here("rawdata", "spatial_data", "MEOW")
```


# Whole region

```{r scrape-data}
# Bounding box for region; formatted as a well-known text object
## (lat long, lat long, lat long, lat long) where each pair is a corner of the bounding box, then closed
obis_bb <- "POLYGON((-161.261728 34.532973,-116.613291 34.532973, -116.613291 62.729976, -161.261728 62.729976, -161.261728 34.532973))"


# occurrence data: all records
#obisdat <- occurrence(geometry = obis_bb)

# checklist for species/taxonomy lst
obisdat <- checklist(geometry = obis_bb)
```

## Fish

```{r fish filter taxonomy}
obisfish <- obisdat %>%
  # only species level records
  filter(taxonRank %in% c('Species', 'Subspecies')) %>%
  # only fish; polyphyletic so can be complicated
  # class covers most of it, some sculpins lack class though
  filter(class %in% c('Actinopteri', 'Elasmobranchii', 'Holocephali',
                      'Petromyzonti', 'Myxini') |
           order %in% c('Scorpaeniformes')) %>%
  # only records that have accepted taxonomy for now
  filter(taxonomicStatus == 'accepted') %>%
  #select only useful columns for now
  select(species, subspecies, taxonRank,
         class, order, family, genus, 
         is_marine, is_brackish, is_freshwater,
         speciesid, taxonID, bold_id, ncbi_id) %>%
  # just in case
  distinct() %>%
  # rank to lowercase to match other databases
  mutate(taxonRank = tolower(taxonRank)) %>%
  # standardize column names
  janitor::clean_names()
  


write_csv(obisfish, here(splists, '20230329_obis-fish.csv'))
```


## Invertebrates

```{r invertebrates filter taxonomy}
obisinverts <- obisdat %>%
  # only species-level records
  filter(taxonRank %in% c('Species', 'Subspecies')) %>%
  # only animals
  filter(kingdom == 'Animalia') %>%
  # only not-vertebrates, 
  # but includes non-vertebrate chordates
  ## c() will also include any NAs in subphylum
  filter(!(subphylum %in% c('Vertebrata'))) %>%
  # only records that have accepted taxonomy for now
  filter(taxonomicStatus == 'accepted') %>%
  #select only useful columns for now
  select(species, subspecies, taxonRank,
         phylum, class, order, family, genus, 
         is_marine, is_brackish, is_freshwater,
         speciesid, taxonID, bold_id, ncbi_id) %>%
  # just in case
  distinct() %>%
  # rank to lowercase to match other databases
  mutate(taxonRank = tolower(taxonRank)) %>%
  # standardize column names
  janitor::clean_names()


write_csv(obisinverts, here(splists, '20230329_obis-invertebrates.csv'))

```


# By ecoregion

```{r set up ecoregions}
# World map
library(rnaturalearth)
library(sf)

# basemap
world_map <- ne_countries(scale = 'small', returnclass = c("sf"))

meow <- read_sf(here(spatial, "meow_ecos_simple.shp")) %>%
  janitor::clean_names()
ppow <- read_sf(here(spatial, "ppow_simple_NEP.shp")) %>%
  janitor::clean_names()


# Base map
## what does kk mean?
kk <- ggplot() +
  # fill = col to remove country borders
  geom_sf(data = world_map, size = .2, fill = "gray80", col = "gray80") + 
  theme(panel.grid.major = element_line(color = gray(0.9), 
                                        linetype = "dashed"))

```

```{r checklist function}
# requires robis to be loaded
library(robis)

# takes a dataframe that 
obis_checklist <- function(region_df) {
  # make blank object
  search <- tibble()
  region_geo <- region_df$wkt
  region_name <- region_df$ecoregion
  # loop by 
  for (i in 1:length(region_geo)) {
    #region_geo <- region_df$wkt
    print(paste0('searching for ', region_name[i]))
    found_sp <- checklist(geometry = region_geo[i],
                          startdate = '1945-01-01') %>%
      # only keep animals
      filter(kingdom == 'Animalia') %>%
      # only keep things at the levels we want
      filter(taxonRank %in% c('Species', 'Subspecies',
                              'Tribe', 'Variety', 'Forma',
                              'Genus', 'Subgenus', NA))
      found_sp$region = paste(region_name[i])
    message('done')
    
    search <- bind_rows(search, found_sp)
  }
  #names(search) <- region_df
  #search_output <- map_dfr(.x = search, ~ data.frame(.x), .id = 'query') %>%
  #  janitor::clean_names()# %>%
  #  select(!(c(url, taxon_rank_id, citation, lsid, modified)))
  return(search)
}
```



## MEOW

```{r meow checklist}
#Ecoregions
# check on map
kk +  
  geom_sf(data = meow, 
          aes(fill = ecoregion), 
          linewidth = .2, 
          col = 0, 
          alpha=.3) +
  ggtitle("MEOW REALM") +
  ggtitle(paste0("Marine Ecoregions of the World (MEOW)(Spalding et al., 2007) - ", 
                 length(unique(meow$ecoregion))," Ecoregions")) +
  theme(legend.position = "none") +
  coord_sf(expand = FALSE)


#meow
meow$wkt <- st_as_text(meow$geometry) #create well known text of ecoregions
# make sure its all valid?
st_is_valid(meow$geometry, reason = TRUE)


meow_nep <- meow %>% #filter for regions of interest
  filter(ecoregion %in% c("Aleutian Islands", "Gulf of Alaska", "North American Pacific Fijordland", 
                        "Puget Trough/Georgia Basin", "Oregon, Washington, Vancouver Coast and Shelf",
                        "Northern California", "Southern California Bight"))


# use function to extract species list by region
meow_nep_checklist <- obis_checklist(meow_nep)


```

### Fish

```{r meow-fish}
meow_fish <- meow_nep_checklist %>%
  # only species level records
  filter(taxonRank %in% c('Species', 'Subspecies')) %>%
  # only fish; polyphyletic so can be complicated
  # class covers most of it, some sculpins lack class though
  filter(class %in% c('Actinopteri', 'Elasmobranchii', 'Holocephali',
                      'Petromyzonti', 'Myxini') |
           order %in% c('Scorpaeniformes')) %>%
  # only records that have accepted taxonomy for now
  #filter(taxonomicStatus == 'accepted') %>%
  #select only useful columns for now
  select(acceptedNameUsage, taxonomicStatus, species, subspecies, taxonRank,
         class, order, family, genus, 
         is_marine, is_brackish, is_freshwater,
         speciesid, taxonID, bold_id, ncbi_id, region) %>%
  # just in case
  distinct() %>%
  # rank to lowercase to match other databases
  mutate(taxonRank = tolower(taxonRank)) %>%
  # standardize column names
  janitor::clean_names() %>%
  mutate(found_taxa = coalesce(accepted_name_usage, subspecies, species)) %>%
  relocate(found_taxa)
  



write_csv(meow_fish, here(splists, '20230411_obis-fish_meow.csv'))
```

### Invertebrates

```{r invertebrates filter taxonomy}
meow_inverts <- meow_nep_checklist %>%
  # only species-level records
  #filter(taxonRank %in% c('Species', 'Subspecies',
  #                            'Tribe', 'Variety', 'Forma',
  #                            'Genus', 'Subgenus', NA)) %>%
  # only animals
  filter(kingdom == 'Animalia') %>%
  # only not-vertebrates, 
  # but includes non-vertebrate chordates
  ## c() will also include any NAs in subphylum
  filter(!(subphylum %in% c('Vertebrata'))) %>%
  # only records that have accepted taxonomy for now
  filter(taxonomicStatus == 'accepted') %>%
  #select only useful columns for now
  select(acceptedNameUsage, taxonomicStatus, species, subspecies, taxonRank,
         phylum, class, order, family, genus, 
         is_marine, is_brackish, is_freshwater,
         speciesid, taxonID, bold_id, ncbi_id, genusid) %>%
  # just in case
  distinct() %>%
  # rank to lowercase to match other databases
  mutate(taxonRank = tolower(taxonRank)) %>%
  # standardize column names
  janitor::clean_names() %>%
  mutate(found_taxa = coalesce(accepted_name_usage, subspecies, species)) %>%
  relocate(found_taxa)


write_csv(meow_inverts, here(splists, '20230411_obis-invertebrates_meow.csv'))

```




```{r}

```




